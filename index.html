<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–¢–∞–π–Ω—ã–π –°–∞–Ω—Ç–∞</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<div class="snow" aria-hidden="true" id="snow"></div>

<div class="wrap">
  <header>
    <div class="badge">–¢–ê–ô–ù–´–ô –°–ê–ù–¢–ê</div>
    <!-- h1 —É–¥–∞–ª—ë–Ω –ø–æ –ø—Ä–æ—Å—å–±–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="sub">–í–≤–æ–¥–∏—Ç–µ –∏–º–µ–Ω–∞, —Ä–∞–∑–¥–∞–≤–∞–π—Ç–µ –ø–∞—Ä—ã, –∞ –∫–∞–∂–¥—ã–π —É–∑–Ω–∞–µ—Ç —Å–≤–æ–µ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ–±—è ‚≠ê</div>
  </header>

  <div class="panel">
    <div class="garland" aria-hidden="true">
      <div class="bulb"></div><div class="bulb"></div><div class="bulb"></div>
      <div class="bulb"></div><div class="bulb"></div><div class="bulb"></div>
      <div class="bulb"></div><div class="bulb"></div><div class="bulb"></div>
    </div>

    <div class="grid">
      <div class="col-12">
        <div class="row">
          <div>
            <label for="count">–°–∫–æ–ª—å–∫–æ –ª—é–¥–µ–π —É—á–∞—Å—Ç–≤—É–µ—Ç?</label>
            <input id="count" type="number" min="3" max="200" value="6" />
          </div>
          <div style="max-width:220px">
            <button id="makeInputs" class="btn alt" title="–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—è –¥–ª—è –∏–º—ë–Ω">–°–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫</button>
          </div>
        </div>
        <div class="warn tiny" id="countHelp">–ú–∏–Ω–∏–º—É–º 3 —á–µ–ª–æ–≤–µ–∫–∞</div>
      </div>

      <div class="col-12 divider"></div>

      <div class="col-12">
        <label>–ò–º–µ–Ω–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
        <div class="names" id="namesList" aria-live="polite"></div>
        <div class="row" style="margin-top:12px">
          <button id="fillExamples" class="btn ghost" type="button">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∏–º–µ–Ω–∞–º–∏ –±–∞–Ω–¥—ã</button>
          <!-- –£–±—Ä–∞–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è, —Ç–µ–ø–µ—Ä—å –æ–Ω–∞ –∫–∞–∫ —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ -->
          <button id="generate" class="btn" type="button">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∂–µ—Ä–µ–±—å—ë–≤–∫—É</button>
          <button id="reset" class="btn ghost" type="button">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
        <div class="warn" id="namesWarn" hidden>–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 3 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–º–µ–Ω–∏ –±–µ–∑ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫.</div>
      </div>

      <div class="col-12 divider"></div>

      <div class="col-12">
        <label><span class="highlight">–ö–∞–∂–¥—ã–π –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–≤–æ—é –∫–∞—Ä—Ç–æ—á–∫—É</span></label>
        <div id="results" class="cards" aria-live="polite"></div>
        <div id="afterInfo" class="tiny" style="margin-top:8px" hidden>
        </div>
      </div>
    </div>
  </div>

  <footer>
    –û–û–û –•—É–µ–≤—à–≤–∏–µ ‚õÑ
  </footer>
</div>

<script>
  // --- Snow generator (–º–æ–±–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è) ---
  (function snow(){
    const root = document.getElementById('snow');

    // –ü–æ–¥–±–∏—Ä–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–Ω–µ–∂–∏–Ω–æ–∫ –ø–æ–¥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ —ç–∫—Ä–∞–Ω
    const isSmall = window.matchMedia('(max-width: 720px)').matches;
    const cores = navigator.hardwareConcurrency || 4;
    const mem = navigator.deviceMemory || 4;
    const perfCoef = Math.min(cores/4, mem/4); // ~1 –Ω–∞ —Å—Ä–µ–¥–Ω–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

    const BASE = isSmall ? 24 : 60; // –±—ã–ª–æ 80
    const FLAKES = Math.max(10, Math.round(BASE * perfCoef));

    // –ß–∞–Ω–∫—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å main thread
    let created = 0;
    const batch = 8;
    function spawnBatch(){
      const upTo = Math.min(created + batch, FLAKES);
      for (let i=created; i<upTo; i++){
        const f = document.createElement('div');
        f.className = 'flake';
        const size = 4 + Math.random()*6;
        f.style.width = f.style.height = size + 'px';
        f.style.left = Math.random()*100 + 'vw';
        const dur = 10 + Math.random()*10; // –Ω–µ–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ
        f.style.animationDuration = dur + 's, ' + (3 + Math.random()*4) + 's';
        f.style.animationDelay = (-Math.random()*dur) + 's, ' + (Math.random()*2) + 's';
        f.style.opacity = 0.45 + Math.random()*0.45;
        root.appendChild(f);
      }
      created = upTo;
      if (created < FLAKES){
        (window.requestIdleCallback||window.requestAnimationFrame)(spawnBatch);
      }
    }
    spawnBatch();
  })();

  const count = document.getElementById('count');
  const makeInputs = document.getElementById('makeInputs');
  const namesList = document.getElementById('namesList');
  const namesWarn = document.getElementById('namesWarn');
  const generateBtn = document.getElementById('generate');
  const resetBtn = document.getElementById('reset');
  const results = document.getElementById('results');
  const afterInfo = document.getElementById('afterInfo');
  const fillExamples = document.getElementById('fillExamples');

  // —Å–æ–∑–¥–∞—Ç—å –æ–¥–Ω–æ –ø–æ–ª–µ –∏–º–µ–Ω–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü —Ç–µ–∫—É—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
  function addNameInput(value = ''){
    const wrap = document.createElement('div');
    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = '–ò–º—è ' + (namesList.querySelectorAll('input').length + 1);
    input.autocomplete = 'off';
    input.inputMode = 'text';
    input.value = value;
    wrap.appendChild(input);
    return wrap;
  }

  function ensureAddTile(){
    let tile = document.getElementById('addTile');
    if (!tile){
      tile = document.createElement('button');
      tile.id = 'addTile';
      tile.type = 'button';
      tile.className = 'add-tile';
      tile.textContent = '–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞';
      tile.addEventListener('click', addOne, {passive:true});
      tile.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); addOne(); }});
    }
    namesList.appendChild(tile);
  }

  function renderNameInputs(n){
    namesList.innerHTML = '';
    for (let i=0;i<n;i++) namesList.appendChild(addNameInput(''));
    ensureAddTile();
  }

  function getCleanNames(){
    const inputs = namesList.querySelectorAll('input[type="text"]');
    const raw = Array.from(inputs).map(i => (i.value || '').trim()).filter(Boolean);
    const seen = new Set();
    const names = [];
    for (const x of raw){
      const key = x.toLocaleLowerCase();
      if (!seen.has(key)){ names.push(x); seen.add(key); }
    }
    return names;
  }

  function derangement(items){
    const n = items.length;
    const idx = Array.from({length:n}, (_,i)=>i);
    for (let i=n-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [idx[i], idx[j]] = [idx[j], idx[i]];
    }
    for (let i=0;i<n;i++){
      if (idx[i] === i){
        const j = (i+1) % n;
        [idx[i], idx[j]] = [idx[j], idx[i]];
      }
    }
    for (let i=0;i<n;i++){
      if (idx[i] === i) return derangement(items);
    }
    const pairs = new Map();
    for (let i=0;i<n;i++){
      pairs.set(items[i], items[idx[i]]);
    }
    return pairs;
  }

  function renderResults(pairs){
    results.innerHTML = '';
    afterInfo.hidden = false;

    const entries = Array.from(pairs.entries());
    // —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏—è –ø–æ—Ä—è–¥–∫–∞ ‚Äî Fisher‚ÄìYates
    for (let i=entries.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [entries[i], entries[j]] = [entries[j], entries[i]];
    }

    // –§—Ä–∞–≥–º–µ–Ω—Ç –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–æ–∫
    const frag = document.createDocumentFragment();

    for (const [giver, receiver] of entries){
      const card = document.createElement('div'); 
      card.className = 'card';

      const flip = document.createElement('div'); 
      flip.className = 'flip';

      const front = document.createElement('div'); 
      front.className = 'face front';
      front.innerHTML = `
      <div class="name">üéÖ ${escapeHTML(giver)}</div>
      <div class="hint">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è</div>
      <button class="btn ghost" type="button">–ü–æ–∫–∞–∑–∞—Ç—å</button>
    `;

      const back = document.createElement('div'); 
      back.className = 'face back';
      back.innerHTML = `
      <div class="hint tiny">–í—ã –¥–∞—Ä–∏—Ç–µ –ø–æ–¥–∞—Ä–æ–∫:</div>
      <div class="receiver">üéÅ ${escapeHTML(receiver)}</div>
      <button class="btn ghost" type="button">–°–∫—Ä—ã—Ç—å</button>
    `;

      const showBtn = front.querySelector('button');
      const hideBtn = back.querySelector('button');

      showBtn.addEventListener('click', ()=>{
        if (card.dataset.locked === '1') return;
        card.classList.add('revealed');
      }, {passive:true});

      hideBtn.addEventListener('click', ()=>{
        card.classList.remove('revealed');
        card.dataset.locked = '1';
        card.classList.add('locked');
        front.innerHTML = `
        <div class="name">üéÖ ${escapeHTML(giver)}</div>
        <div class="hint">–£–∂–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ üîí</div>
      `;
      }, {passive:true});

      flip.appendChild(front);
      flip.appendChild(back);
      card.appendChild(flip);
      frag.appendChild(card);
    }

    results.appendChild(frag);
    results.scrollIntoView({behavior:'smooth', block:'start'});
  }

  function escapeHTML(str){
    return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
  }

  function addOne(){
    const current = namesList.querySelectorAll('input[type="text"]').length;
    if (current >= 200) {
      namesWarn.textContent = '–ú–∞–∫—Å–∏–º—É–º 200 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.';
      namesWarn.hidden = false;
      return;
    }
    const wrap = addNameInput('');
    const tile = document.getElementById('addTile');
    namesList.insertBefore(wrap, tile);
    count.value = current + 1;
    namesWarn.hidden = true;
    results.innerHTML = '';
    afterInfo.hidden = true;
    const inp = wrap.querySelector('input');
    inp.focus();
    tile.scrollIntoView({ behavior: 'smooth', block: 'end' });
  }

  // –ö–Ω–æ–ø–∫–∏/–¥–µ–π—Å—Ç–≤–∏—è
  makeInputs.addEventListener('click', ()=>{
    const n = Math.max(3, Math.min(200, parseInt(count.value||'0',10)));
    count.value = n;
    renderNameInputs(n);
    namesWarn.hidden = true; results.innerHTML = ''; afterInfo.hidden = true;
  }, {passive:true});

  fillExamples.addEventListener('click', ()=>{
    const samples = ["–ê–Ω–Ω–∞","–ê–ª—å–±–∏–Ω–∞","–í–∞–ª–µ—Ä–∏—è","–ï–ª–µ–Ω–∞","–í–ª–∞–¥–∏—Å–ª–∞–≤","–ê—Ä—Å–µ–Ω–∏–π","–í–ª–∞–¥–∏–º–∏—Ä"];
    renderNameInputs(samples.length);
    count.value = samples.length;
    const inputs = namesList.querySelectorAll('input[type="text"]');
    inputs.forEach((inp, i) => { inp.value = samples[i]; });
    results.innerHTML = '';
    afterInfo.hidden = true;
    namesWarn.hidden = true;
  }, {passive:true});

  resetBtn.addEventListener('click', ()=>{
    results.innerHTML = ''; afterInfo.hidden = true; namesWarn.hidden = true; namesList.innerHTML = ''; count.value = 6; renderNameInputs(parseInt(count.value,10));
  }, {passive:true});

  generateBtn.addEventListener('click', ()=>{
    const names = getCleanNames();
    if (names.length < 3){
      namesWarn.textContent = '–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 3 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–º–µ–Ω–∏ –±–µ–∑ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫.';
      namesWarn.hidden = false; return;
    }
    namesWarn.hidden = true;
    const pairs = derangement(names);
    renderResults(pairs);
  }, {passive:true});

  // init
  renderNameInputs(parseInt(count.value,10));
</script>
</body>
</html>
